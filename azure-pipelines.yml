# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
- group: Veracode account credentials
- name: repository_name
  value: $[replace($(Build.Repository.Name), '/', '-')]

steps:

- script: zip -r $(repository_name).zip . -x ./node_modules/\*
  displayName: 'Zip application to scan'

- script: curl -O https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
  displayName: Download the Pipeline Scanner

- script: unzip pipeline-scan-LATEST.zip -d $(System.DefaultWorkingDirectory)/veracode
  displayName: Unzip the Pipeline Scanner

- script: java -jar $(System.DefaultWorkingDirectory)/veracode/pipeline-scan.jar
          --file $(System.DefaultWorkingDirectory)/$(repository_name).zip
          --project_name "$(repository_name)"
          --veracode_api_id "$(api_id)"
          --veracode_api_key "$(api_key)"
          --fail_on_severity="Very High, High, Medium"
  displayName: Run Pipeline Scanner